---
name: Add preview link

on:
  pull_request:
    types:
      - opened
  workflow_dispatch:

jobs:
  comment:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo.owner + '/' + context.repo.repo;
            const ref = context.ref;
            const branch = ref.split('/').at(-1);

            const datajson = `https://raw.githubusercontent.com/${repo}/${ref}/src/data.json`;
            const datalink = encodeURIComponent(datajson);
            const previewlink = 'https://alexanderthesensei.github.io/map/preview?data=' + datalink;

            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const pull = pulls.data.find(pr => pr.head.ref === branch);
            await github.rest.issues.createComment({
              issue_number: pull.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Предварительный просмотр доступен [здесь](${previewlink})`,
            })
